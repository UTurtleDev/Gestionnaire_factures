{% extends "base.html" %}

{% block title %}Factures{% endblock title %}

{% block content %}

<div class="title">
    <H2>Factures ({{ factures.paginator.count }})</H2>
    <div class="title_btn">
        <div class="new"><a href="{% url 'factures:create' %}">+ Nouvelle facture</a></div>
    </div>
</div>

<section class="tableau">
    <table class="table">
        <thead>
            <tr>
                <th>
                    <div class="th-div">
                        <span>NUMÉRO</span>
                        <span style="display: none">
                            <svg aria-hidden="true" focusable="false" data-prefix="fad" data-icon="sort-up" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                                <g class="fa-group">
                                    <path fill="currentColor" d="M0 320c0 8.3 3.3 16.5 9.4 22.6l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 288c-12.9 0-24.6 7.8-29.6 19.8C.8 311.7 0 315.9 0 320zm109.3 32l101.5 0L160 402.7 109.3 352z" class="fa-secondary">
                                    </path>
                                    <path fill="currentColor" d="M182.6 41.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-9.2 9.2-11.9 22.9-6.9 34.9s16.6 19.8 29.6 19.8l256 0c12.9 0 24.6-7.8 29.6-19.8s2.2-25.7-6.9-34.9l-128-128z" class="fa-primary">
                                    </path>
                                </g>
                            </svg>
                        </span>
                    </div>
                </th>
                <th>
                    <div class="th-div">
                        <span>MONTANT TTC</span>
                    </div>
                </th>
                <th>
                    <div class="th-div">
                        <span>CLIENT</span>
                    </div>
                </th>
                <th>
                    <div class="th-div">
                        <span>AFFAIRE</span>
                    </div>
                </th>
                <th>
                    <div class="th-div">
                        <span>DATE D'ÉMISSION</span>
                    </div>
                </th>
                <th>
                    <div class="th-div">
                        <span>ECHÉANCE</span>
                    </div>
                </th>
                <th>
                    <div class="th-div">
                    </div>
                </th>
            </tr>
        </thead>
        
        {% if factures %}
        <tbody>
            {% for facture in factures %}
            <tr data-url="{% url 'factures:detail' facture.pk %}" class="clickable-row">
                <td colspan="1">
                    <div class="factures">
                        <p>{{ facture.invoice_number }}</p>
                    </div>
                </td>
                <td colspan="1">
                    <div class="factures">
                        <p>{{ facture.formatted_amount_ttc }}</p>
                    </div>
                </td>
                <td colspan="1">
                    <div class="factures">
                        {% if facture.client %}
                            <a href="{% url 'clients:detail' facture.client.id %}">{{ facture.client.entity_name }}</a>
                        {% else %}
                            {{ facture.client_entity_name }}
                        {% endif %}
                    </div>
                </td>
                <td colspan="1">
                    <div class="factures">
                        <P>{{ facture.affaire.affaire_number }}</P>
                    </div>
                </td>
                <td colspan="1">
                    <div class="factures">
                        <P>{{ facture.date }}</P>
                    </div>
                </td>
                <td colspan="1">
                    <div class="factures">
                        {% if facture.statut != "payee" %}
                            {% if facture.due_date > date %}
                                <P>{{ facture.due_date }}</P>
                            {% else %}
                                <p>{{ facture.day_late }} jours de retard</p>
                            {% endif %}
                        {% else %}
                            <div class="cercle-vert"></div>
                        {% endif %}
                    </div>
                </td>
                <td colspan="1" >
                    <div class="actions-list">
                        {% if facture.facture_pdf %}
                        <div class="actions">
                            <a href="{% url 'factures:download_pdf' facture.pk %}" target="_blank" title="Voir la facture">
                                <svg class="param-svg" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2Z" fill="#d44638" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                                    <polyline points="14,2 14,8 20,8" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 13H8V15H16V13Z" fill="white"/>
                                    <path d="M16 17H8V19H16V17Z" fill="white"/>
                                    <path d="M10 9H8V11H10V9Z" fill="white"/>
                                </svg>
                            </a>
                        </div>
                        {% endif %}
                        <div class="actions">
                            <a href="{% url 'factures:reglement' facture.pk %}">
                                <svg class= "param-svg" width="800px" height="800px" viewBox="0 -196 1416 1416" class="icon"  version="1.1" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M324.358919 22.140541H1361.643243c18.819459 0 33.210811 14.391351 33.210811 33.21081v645.396757c0 18.819459-14.391351 33.210811-33.210811 33.210811H324.358919c-18.819459 0-33.210811-14.391351-33.210811-33.210811V55.351351c0-18.819459 14.391351-33.210811 33.210811-33.21081z" fill="#9DBE87" /><path d="M1361.643243 756.099459H324.358919c-30.996757 0-55.351351-24.354595-55.351351-55.351351V55.351351c0-30.996757 24.354595-55.351351 55.351351-55.351351H1361.643243c30.996757 0 55.351351 24.354595 55.351352 55.351351v645.396757c0 29.88973-24.354595 55.351351-55.351352 55.351351zM324.358919 44.281081c-6.642162 0-11.07027 4.428108-11.07027 11.07027v645.396757c0 6.642162 4.428108 11.07027 11.07027 11.07027H1361.643243c6.642162 0 11.07027-4.428108 11.070271-11.07027V55.351351c0-6.642162-4.428108-11.07027-11.070271-11.07027H324.358919z" fill="#131313" /><path d="M230.261622 116.237838h1038.391351c18.819459 0 33.210811 14.391351 33.210811 33.210811v645.396756c0 18.819459-14.391351 33.210811-33.210811 33.210811H230.261622c-18.819459 0-33.210811-14.391351-33.210811-33.210811V149.448649c0-18.819459 14.391351-33.210811 33.210811-33.210811z" fill="#9DBE87" /><path d="M1267.545946 850.196757H230.261622c-30.996757 0-55.351351-24.354595-55.351352-55.351352V149.448649c0-30.996757 24.354595-55.351351 55.351352-55.351352h1038.391351c30.996757 0 55.351351 24.354595 55.351351 55.351352v645.396756c-1.107027 29.88973-25.461622 55.351351-56.458378 55.351352zM230.261622 138.378378c-6.642162 0-11.07027 4.428108-11.070271 11.070271v645.396756c0 6.642162 4.428108 11.07027 11.070271 11.070271h1038.391351c6.642162 0 11.07027-4.428108 11.07027-11.070271V149.448649c0-6.642162-4.428108-11.07027-11.07027-11.070271H230.261622z" fill="#131313" /><path d="M143.913514 208.121081h1038.391351c18.819459 0 33.210811 14.391351 33.210811 33.210811v645.396757c0 18.819459-14.391351 33.210811-33.210811 33.21081H143.913514c-18.819459 0-33.210811-14.391351-33.210811-33.21081V241.331892c0-17.712432 14.391351-33.210811 33.210811-33.210811z" fill="#9DBE87" /><path d="M1182.304865 942.08H143.913514c-30.996757 0-55.351351-24.354595-55.351352-55.351351V241.331892c0-30.996757 24.354595-55.351351 55.351352-55.351351h1038.391351c30.996757 0 55.351351 24.354595 55.351351 55.351351v645.396757c0 29.88973-25.461622 55.351351-55.351351 55.351351zM143.913514 230.261622c-6.642162 0-11.07027 4.428108-11.070271 11.07027v645.396757c0 6.642162 4.428108 11.07027 11.070271 11.07027h1038.391351c6.642162 0 11.07027-4.428108 11.07027-11.07027V241.331892c0-6.642162-4.428108-11.07027-11.07027-11.07027H143.913514z" fill="#131313" /><path d="M55.351351 290.041081h1038.391352c18.819459 0 33.210811 14.391351 33.210811 33.210811v645.396757c0 18.819459-14.391351 33.210811-33.210811 33.21081H55.351351c-18.819459 0-33.210811-14.391351-33.21081-33.21081V323.251892c0-17.712432 14.391351-33.210811 33.21081-33.210811z" fill="#9DBE87" /><path d="M1093.742703 1024H55.351351c-30.996757 0-55.351351-24.354595-55.351351-55.351351V323.251892c0-30.996757 24.354595-55.351351 55.351351-55.351351h1038.391352c30.996757 0 55.351351 24.354595 55.351351 55.351351v645.396757c0 30.996757-25.461622 55.351351-55.351351 55.351351zM55.351351 312.181622c-6.642162 0-11.07027 4.428108-11.07027 11.07027v645.396757c0 6.642162 4.428108 11.07027 11.07027 11.07027h1038.391352c6.642162 0 11.07027-4.428108 11.07027-11.07027V323.251892c0-6.642162-4.428108-11.07027-11.07027-11.07027H55.351351z" fill="#131313" /><path d="M954.257297 902.227027H194.836757c0-52.03027-43.174054-95.204324-95.204325-95.204324V472.700541c52.03027 0 95.204324-43.174054 95.204325-95.204325h759.42054c0 52.03027 43.174054 95.204324 95.204325 95.204325v334.322162c-53.137297 0-95.204324 43.174054-95.204325 95.204324z" fill="#D6F0C5" /><path d="M954.257297 924.367568H194.836757c-12.177297 0-22.140541-9.963243-22.140541-22.140541 0-39.852973-33.210811-73.063784-73.063784-73.063784-12.177297 0-22.140541-9.963243-22.14054-22.14054V472.700541c0-12.177297 9.963243-22.140541 22.14054-22.140541 39.852973 0 73.063784-33.210811 73.063784-73.063784 0-12.177297 9.963243-22.140541 22.140541-22.14054h759.42054c12.177297 0 22.140541 9.963243 22.140541 22.14054 0 39.852973 33.210811 73.063784 73.063784 73.063784 12.177297 0 22.140541 9.963243 22.14054 22.140541v334.322162c0 12.177297-9.963243 22.140541-22.14054 22.14054-39.852973 0-73.063784 33.210811-73.063784 73.063784 0 12.177297-9.963243 22.140541-22.140541 22.140541z m-739.494054-44.281082h718.460541c8.856216-46.495135 46.495135-84.134054 92.99027-92.99027V492.627027c-46.495135-8.856216-84.134054-46.495135-92.99027-92.99027H214.763243c-8.856216 46.495135-46.495135 84.134054-92.99027 92.99027V785.989189c46.495135 9.963243 84.134054 47.602162 92.99027 94.097297z" fill="#131313" /><path d="M576.761081 790.417297c-35.424865 0-73.063784-13.284324-99.632432-47.602162-7.749189-9.963243-5.535135-23.247568 3.321081-30.996757 9.963243-7.749189 23.247568-5.535135 30.996756 3.321081 26.568649 34.317838 67.528649 35.424865 94.097298 26.568649 22.140541-7.749189 35.424865-22.140541 35.424865-37.638919 0-14.391351-34.317838-24.354595-64.207568-33.210811-46.495135-14.391351-105.167568-30.996757-105.167567-86.348108 0-26.568649 16.605405-50.923243 45.388108-65.314594 35.424865-17.712432 95.204324-24.354595 151.662702 16.605405 9.963243 7.749189 12.177297 21.033514 4.428108 30.996757-7.749189 9.963243-21.033514 12.177297-30.996756 4.428108-37.638919-27.675676-79.705946-26.568649-105.167568-13.284324-13.284324 6.642162-22.140541 16.605405-22.14054 26.568648 0 21.033514 30.996757 30.996757 73.063783 44.281081 45.388108 13.284324 95.204324 28.782703 95.204325 75.277838 0 34.317838-25.461622 65.314595-65.314595 79.705946-11.07027 3.321081-26.568649 6.642162-40.96 6.642162z" fill="#131313" /><path d="M574.547027 549.085405c-12.177297 0-22.140541-9.963243-22.140541-22.14054v-48.709189c0-12.177297 9.963243-22.140541 22.140541-22.140541s22.140541 9.963243 22.140541 22.140541v48.709189c0 13.284324-9.963243 22.140541-22.140541 22.14054z" fill="#131313" /><path d="M574.547027 832.484324c-12.177297 0-22.140541-9.963243-22.140541-22.14054v-36.531892c0-12.177297 9.963243-22.140541 22.140541-22.140541s22.140541 9.963243 22.140541 22.140541v36.531892c0 12.177297-9.963243 22.140541-22.140541 22.14054z" fill="#131313" /><path d="M285.612973 653.145946m-40.96 0a40.96 40.96 0 1 0 81.92 0 40.96 40.96 0 1 0-81.92 0Z" fill="#AECD99" /><path d="M285.612973 715.139459c-34.317838 0-63.100541-27.675676-63.100541-63.10054s27.675676-63.100541 63.100541-63.100541c34.317838 0 63.100541 27.675676 63.100541 63.100541s-28.782703 63.100541-63.100541 63.10054z m0-80.812973c-9.963243 0-18.819459 7.749189-18.819459 18.81946s7.749189 18.819459 18.819459 18.819459c9.963243 0 18.819459-7.749189 18.819459-18.819459s-8.856216-18.819459-18.819459-18.81946z" fill="#131313" /><path d="M865.695135 653.145946m-40.96 0a40.96 40.96 0 1 0 81.92 0 40.96 40.96 0 1 0-81.92 0Z" fill="#AECD99" /><path d="M865.695135 715.139459c-34.317838 0-63.100541-27.675676-63.10054-63.10054s27.675676-63.100541 63.10054-63.100541c34.317838 0 63.100541 27.675676 63.100541 63.100541s-28.782703 63.100541-63.100541 63.10054z m0-80.812973c-9.963243 0-18.819459 7.749189-18.819459 18.81946s7.749189 18.819459 18.819459 18.819459 18.819459-7.749189 18.81946-18.819459-8.856216-18.819459-18.81946-18.81946z" fill="#131313" />
                                </svg>
                            </a>
                        </div>
                    </div>
                </td>
            </tr>
            {% empty %}
            <p>Aucune facture trouvée</p>
            {% endfor %}
        </tbody>
        {% endif %}
        
    </table>
    <!-- Navigation de pagination -->
    <div class="pagination-container">
        
        <div class="pagination-nav">
            <!-- Bouton Précédent -->
            {% if factures.has_previous %}
            <a href="?page=1" class="btn">«</a>
            {% comment %} <a href="?page={{ factures.previous_page_number }}" class="btn">‹ Précédent</a> {% endcomment %}
            {% endif %}
            
            <!-- Numéros de pages -->
            {% for num in factures.paginator.page_range %}
            {% if factures.number == num %}
            <span class="current-page">{{ num }}</span>
            {% else %}
            <a href="?page={{ num }}" class="btn">{{ num }}</a>
            {% endif %}
            {% endfor %}
            
            <!-- Bouton Suivant -->
            {% if factures.has_next %}
            {% comment %} <a href="?page={{ factures.next_page_number }}" class="btn">Suivant ›</a> {% endcomment %}
            <a href="?page={{ factures.paginator.num_pages }}" class="btn">»</a>
            {% endif %}
        </div>
        <div class="pagination-info">
            <p>
                Page {{ factures.number }} sur {{ factures.paginator.num_pages }}
            </p>
        </div>
    </div>
    

</section>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const clickableRows = document.querySelectorAll('.clickable-row');
        clickableRows.forEach(row => {
            row.addEventListener('click', function(event) {
                // Empêche la redirection si on clique sur un lien dans les actions
                if (event.target.closest('.actions') || event.target.closest('a')) {
                    return;
                }
                window.location = this.dataset.url;
            });
        });
    });
</script>


{% endblock content %}