{% extends "base_form.html" %}

{% block title %} Affaire {{ affaire.affaire_number }} {% endblock title %}

{% block content %}


<div class="title">
    <H2>Affaire {{ affaire.affaire_number }} - {{ affaire.client.entity_name }}</H2>
        <div class="form_btn_group">
            <a href="#" onclick="history.back(); return false;" class="form_btn">Retour</a>
            <a href="{% url 'affaires:modifier' affaire.pk %}" class="form_btn">Modifier</a>
        </div>
</div>

<section class="tableau">
    <div class="card">
        <div class="card-body">
            <div class="">
                <div>
                    <div class="form_categories">
                        <div class="form-group">
                            <p class="form-label">N° Affaire</p>
                            <p class="form-input">{{ affaire.affaire_number }}</p>
                        </div>
                        <div class="form-group">
                            <p class="form-label">Client</p>
                            <p class="form-input">{{ affaire.client.entity_name }}</p>
                        </div>
                        <div class="form-group">
                            <p class="form-label">Auteur</p>
                            <p class="form-input">{{ affaire.author|default:"Non défini" }}</p>
                        </div>
                    </div>
                    
                    <div class="form_categories">
                        <div class="form-group">
                            <p class="form-label">Budget HT</p>
                            <p class="form-input">{{ affaire.formatted_budget }}</p>
                        </div>
                        <div class="form-group">
                            <p class="form-label">Facturé</p>
                            <p class="form-input">{{ affaire.formatted_total_facture_ht }}</p>
                        </div>

                    </div>

                    <div>
                        <p class="form-label">Déscription</p>
                        <p class="form-area">{{ affaire.affaire_description }}</p>
                    </div>
                    <div>
                        <p class="form-label">Facturation</p>
                        <div class="form-area">
                            {% for facture in affaire.invoices.all %}
                                <p data-url="{% url 'factures:detail' facture.pk %}" class="clickable-row">{{ facture.invoice_number }} - {{ facture.formatted_amount_ht }}</p>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Section Contacts -->
                    <div class="form_categories">
                        <div class="form-group">
                            <p class="form-label">Contacts de l'affaire</p>
                            {% if contacts %}
                                {% for contact in contacts %}
                                    <div class="contact-item" style="margin-bottom: 10px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
                                        <p><strong>{{ contact.nom }} {{ contact.prenom }}</strong> 
                                        {% if contact.is_principal %}<span style="color: #4CAF50;">(Principal)</span>{% endif %}</p>
                                        {% if contact.fonction %}<p>Fonction : {{ contact.fonction }}</p>{% endif %}
                                        {% if contact.email %}<p>Email : {{ contact.email }}</p>{% endif %}
                                        {% if contact.phone_number %}<p>Téléphone : {{ contact.phone_number }}</p>{% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="form-input">Aucun contact</p>
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    

</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const clickableRows = document.querySelectorAll('.clickable-row');
        clickableRows.forEach(row => {
            row.addEventListener('click', function(event) {
                // Empêche la redirection si on clique sur un lien dans les actions
                if (event.target.closest('.actions') || event.target.closest('a')) {
                    return;
                }
                window.location = this.dataset.url;
            });
        });
    });
</script>



{% endblock content %}